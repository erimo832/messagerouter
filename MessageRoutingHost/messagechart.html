<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>    
    <!-- theme reference -->
    <link id="theme" href="/css/themes/default.css" rel="stylesheet" />

    <!--<script src="Scripts/json2.js"></script>-->

    <script src="Scripts/jquery-2.2.1.min.js"></script>
    <script src="Scripts/jquery.signalR-2.2.0.js"></script>
    <script src="signalr/hubs"></script>

    <!-- test chart js -->
    <script src="Scripts/Chart.js"></script>

    <script src="Scripts/messagerouterconnection.js"></script>
    <script src="Scripts/common.js"></script>
    <script src="Scripts/theme.js"></script>
    <script src="Scripts/datetime.js"></script>


    <script type="text/javascript">
    $(function () {
        
        //TODO: test differnt apis
        //chart.js http://www.chartjs.org/
        //Chartist.js http://gionkunz.github.io/chartist-js/
        //some more here https://www.sitepoint.com/15-best-javascript-charting-libraries/

        var msg =
                    "<p>I need parameters to work! </p>" +
                    "Valid parameters:<br />" +
                    " - name <br />" +
                    " - width <br />" +
                    " - height <br />" +
                    " - aggregatelevel (what topic level should it be aggregated on) <br />" +
                    " - topic (separate with , for multiple topics. Valid wildcards for subscriptions is * and # (use %23 for #)) <br />" +
                    " - theme (name of theme on server. Avalible themes: 'c64', 'light', 'lightcream', 'night', 'nightcream', 'sand', 'terminal') <br />" +
                    " - size (base font-size) <br />" +
                    " - xaxislabel (complete topic (aggregatelevel) if empty. Otherwise ex: 0,2 from topic XXX.YYY.ZZZ gives XXX.ZZZ) <br />" +
                    "<p>Example: <br />" +
                    "messagechart.html?name=xyz&topic=topic1.*,topic2.%23&theme=night</p>";


        /*TODO:
        - Refactor this file
            - Move "common" dataset handling
        - Refactor signalr connection
            - Split connection
            - Subscribe part
            - Publish part
        - Spider chart option
        - Test other js chart library
        - Add reset data counter button
        - Add last reset time somewhere small
        - Create group by day, bars for one "topic"
        - Problem log loses connection it seems like
        */

        //chart defaults
        Chart.defaults.global.legend.display = false;
        Chart.defaults.global.defaultFontStyle = "bold";
        
        var ctx = $("#chart");
        var myBarChart;
        //default settings
        var dataset = [];

        var xaxislabel;

        function getlabel(name)
        {
            if (xaxislabel == "-1")
                return name;

            var indexes = xaxislabel.split(",");
            var parts = name.split(".");
            var result = "";

            for (var i = 0; i < indexes.length; i++) {
                if (i == 0) {
                    result = parts[indexes[i]];
                }
                else {
                    result = result + "." + parts[indexes[i]];
                }
            }

            return result;
        }
        
        function addMessageToDataset(msg, aggregatelevel)
        {
            var topic = msg.Topic;

            //get the name that it should sum under
            var parts = topic.split(".");
            var name = "";
            var label = "";

            if (parts.length > aggregatelevel) {
                for (var i = 0; i < aggregatelevel; i++) {
                    if (i == 0) {
                        name = parts[i];
                    }
                    else {
                        name = name + "." + parts[i];
                    }
                }
            }
            else {
                name = topic;
            }

            //add in dataset
            var found = false;
            for (var i = 0; i < dataset.length; i++) {
                if (dataset[i].name == name) {
                    dataset[i].data = dataset[i].data + 1;
                    found = true;
                    break;
                }
            }

            if (!found) {
                var item = { name: name, data: 1, label: getlabel(name) };
                dataset.push(item);
            }
        }

        function createChartJsDataset() {
            
            var labels = [];
            var datapoints = [];

            //could do it like .chart-color-1 .... .chart-color-default, to support multiple
            var color = getStyleRuleValue('color', '.chart-color');
            var backgroundcolors = [];
            for (var i = 0; i < dataset.length; i++) {
                backgroundcolors.push(color);
            }            

            var data = {
                labels: dataset.map(function (x) { return x.label }),                
                datasets: [
                    {
                        backgroundColor: backgroundcolors,
                        borderWidth: 1,                        
                        data: dataset.map(function (x) { return x.data }),
                    }
                ]
            };

            return data;
        }

        $(document).ready(function () {
            var msghub = startSignalrConnection(msg);
            var fontSize = getQueryParam("size", 16);
            var agglevel = getQueryParam("aggregatelevel", 4);

            xaxislabel = getQueryParam("xaxislabel", "-1");

            //Set size of chart
            var width = getQueryParam("width", 800);
            var height = getQueryParam("height", 400);
            $("#chart").attr("width", width);
            $("#chart").attr("height", height);
            
            //register for event
            msghub.client.resetView = function (viewType) {
                if (viewType == "all" || viewType == "chart") {
                    resetView();
                }
            };

            msghub.client.newMessage = function (json) {
                var msg = jQuery.parseJSON(json);
                //Level, Text, Topic

                addMessageToDataset(msg, agglevel);

                var data = createChartJsDataset();

                if (myBarChart != null) {
                    myBarChart.destroy();
                }

                var gridcolor = getStyleRuleValue('color', '.chart-grid-color');
                
                myBarChart = new Chart(ctx, {                    
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: false,
                        hover: {                          
                            mode: 'x-axis'
                        },
                        scales: {
                            xAxes: [{                                
                                gridLines: {
                                    color: gridcolor
                                },
                                ticks: {
                                    fontSize: fontSize,
                                    fontColor: gridcolor
                                }
                            }],
                            yAxes: [{                                
                                gridLines: {
                                    color: gridcolor
                                },
                                ticks: {
                                    fontSize: fontSize,
                                    fontColor: gridcolor,
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });               
            };

            $('#body').keyup(function (event) {
                if (event.which == 82) {
                    resetView();
                }
            });

            function resetView() {
                //Clear dataset
                dataset = [];

                if (myBarChart != null) {
                    myBarChart.destroy();
                }
            }
        });
    });
    </script>

</head>
<body id="body" style="margin: 0;">
    <div id="serverStatus" class="error">
    </div>

    <div id="message">
    </div>

    <canvas id="chart" width="800" height="400"></canvas>


</body>
</html>
