<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <!-- theme reference -->
    <link id="theme" href="/css/themes/default.css" rel="stylesheet" />

    <!--
        
        - Refactor code move common stuff into js
        - add some parameter
            * linear/series
            * max number of records
            * max time window
            * part of topic as label?
        - Show area?
        -

        - Possible to show area between values
    -->


    <script src="/Scripts/jquery-2.2.1.min.js"></script>
    <script src="/Scripts/jquery.signalR-2.2.0.js"></script>
    <script src="/signalr/hubs"></script>

    <script src="/Scripts/moment.min.js"></script>
    <script src="/Scripts/Chart.js"></script>
    

    <script src="/Scripts/messagerouterconnection.js"></script>
    <script src="/Scripts/common.js"></script>
    <script src="/Scripts/theme.js"></script>
    <script src="/Scripts/datetime.js"></script>
    <script src="/Scripts/View/commoncharts.js"></script>

    <script type="text/javascript">
    $(function () {

        //TODO: test differnt apis
        //chart.js http://www.chartjs.org/
        //Chartist.js http://gionkunz.github.io/chartist-js/
        //some more here https://www.sitepoint.com/15-best-javascript-charting-libraries/

        var msg =
                    "<p>I need parameters to work! </p>" +
                    "Valid parameters:<br />" +
                    " - name <br />" +
                    " - width <br />" +
                    " - height <br />" +                    
                    " - topic (separate with , for multiple topics. Valid wildcards for subscriptions is * and # (use %23 for #)) <br />" +
                    " - theme (name of theme on server. Avalible themes: 'c64', 'light', 'lightcream', 'night', 'nightcream', 'sand', 'terminal') <br />" +
                    " - size (base font-size) <br />" +                    
                    "<p>Example: <br />" +
                    "messagechart.html?name=xyz&topic=topic1.*,topic2.%23&theme=night</p>";

        
        var params = function () {
            var obj =
            {
                fontSize: getQueryParam("size", 16), //chart, label
                width: getQueryParam("width", 800), //chart
                height: getQueryParam("height", 400), //chart
                topic: getQueryParam("topic", "#"), //connection
                name: getQueryParam("name"), //connection
                theme: getQueryParam("theme") //layout
            };
             
            return obj;
        }();

        //var themesettings = function () {
        //    var obj =
        //    {
        //        gridcolor: getStyleRuleValue('color', '.chart-grid-color'),
        //        color: getStyleRuleValue('color', '.chart-color')
        //    };

        //    return obj;
        //}();

       /* var params = (function () {
            var instance;

            function createInstance() {
                var obj =
                {
                    fontSize: getQueryParam("size", 16), //chart, label
                    width: getQueryParam("width", 800), //chart
                    height: getQueryParam("height", 400), //chart
                    topic: getQueryParam("topic", "#"), //connection
                    name: getQueryParam("name"), //connection
                    theme: getQueryParam("theme"), //layout
                    //gridcolor: getStyleRuleValue('color', '.chart-grid-color'),
                    //color: getStyleRuleValue('color', '.chart-color')
                };

                return obj;
            }

            return {
                getInstance: function () {
                    if (!instance) {
                        instance = createInstance();
                    }
                    return instance;
                }
            };
        })();*/



        //chart defaults
        Chart.defaults.global.legend.display = false;
        Chart.defaults.global.defaultFontStyle = "bold";

        var ctx = $("#chart");
        var myBarChart;
        //default settings
        var dataset = [];
        
        

        $(document).ready(function () {


            var msghub = startSignalrConnection(msg);

            //Set size of chart
            $("#chart").attr("width", params.width);
            $("#chart").attr("height", params.height);

            //register for event
            msghub.client.resetView = function (viewType) {
                if (viewType == "all" || viewType == "chart") {
                    resetView();
                }
            };

            msghub.client.newMessage = function (json) {
                var msg = jQuery.parseJSON(json);                
                var dataPoint = jQuery.parseJSON(msg.JsonObject);

                //add datapoint to set
                dataset.push(dataPoint);
                                
                //reset chart
                if (myBarChart != null) {
                    myBarChart.destroy();
                }
                               

                var labels = dataset.map(function (item) {
                    return new Date(item.Timestamp);
                });

                var values = dataset.map(function (item) {
                    return item.Value;
                });

                var gridcolor = getStyleRuleValue('color', '.chart-grid-color');
                var color = getStyleRuleValue('color', '.chart-color');
                var fontFamily = getStyleRuleValue('font-family', '.chart-font-family');
                                              

                var config = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Set1",
                            //backgroundColor: color(window.chartColors.red).alpha(0.5).rgbString(),
                            backgroundColor: color,
                            borderColor: color,
                            fill: false,
                            data: values,
                        }]
                    },
                    options: {
                        title: {
                            text: "Values"
                        },
                        scales: {
                            xAxes: [{
                                type: "time",
                                distribution: 'linear', //'series',
                                gridLines: {
                                    color: gridcolor
                                },
                                ticks: {
                                    fontSize: params.fontSize,
                                    fontColor: color,
                                    fontFamily: fontFamily,
                                    autoSkip: true,
                                    maxTicksLimit: 10,
                                },
                                time: {
                                    format: "HH:mm",
                                    unit: 'minute',
                                    //round: 'second', 
                                    tooltipFormat: 'H:mm:ss',
                                    displayFormats: {
                                        'minute': 'HH:mm',
                                        'hour': 'HH:mm'
                                    },
                                },
                                scaleLabel: {
                                    display: true,                                    
                                    labelString: 'Date'
                                }
                            }, ],
                            yAxes: [{
                                gridLines: {
                                    color: gridcolor
                                },
                                ticks: {
                                    fontSize: params.fontSize,
                                    fontColor: color,
                                    fontFamily: fontFamily,
                                    maxTicksLimit: 10,
                                    beginAtZero: true
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: 'value'
                                }
                            }]
                        },
                    }
                };

                myBarChart = new Chart(ctx, config);

                /*
                options: {
                        responsive: false,
                        hover: {                          
                            mode: 'x-axis'
                        },
                        scales: {
                            xAxes: [{                                
                                gridLines: {
                                    color: gridcolor
                                },
                                ticks: {
                                    fontSize: fontSize,
                                    fontColor: gridcolor
                                }
                            }],
                            yAxes: [{                                
                                gridLines: {
                                    color: gridcolor
                                },
                                ticks: {
                                    fontSize: fontSize,
                                    fontColor: gridcolor,
                                    beginAtZero: true
                                }
                            }]
                        }
                */
                
            };
        });
    });

    </script>

</head>
<body id="body" style="margin: 0;">
    <div id="serverStatus" class="error">
    </div>

    <div id="message">
    </div>

    <canvas id="chart" width="800" height="400"></canvas>


</body>
</html>
